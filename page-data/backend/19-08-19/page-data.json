{"componentChunkName":"component---src-templates-post-js","path":"/backend/19-08-19/","result":{"data":{"markdownRemark":{"html":"<p>Node.js와 mysql, AWS EC2, S3, Nginx 등을 연동하여 백엔드 작업을 하고있는데 가끔씩 'Error: Connection lost: The server closed the connection.' 이라는 에러 로그가 뜨면서 웹 사이트에 접속이 되지 않을 때가 있습니다. 구글링을 통해 왜 이런 에러가 발생하는지, 어떤 방식으로 해결 할 수 있는지에 대해 알게 된 내용을 아래에 적어봅니다.</p>\n<h3 id=\"error의-원인\" style=\"position:relative;\"><a href=\"#error%EC%9D%98-%EC%9B%90%EC%9D%B8\" aria-label=\"error의 원인 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Error의 원인</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 760px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fa8cf8a2f5e0504005c8df8b8036978d/21b4d/19-08-19.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.73684210526316%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApElEQVQoz42RUQ6EIAxEERSDgKxKkF3F+x9zX/AAMB8NTXidoYh934/joIYQYoyfqvM8l2URTTnnuA2plKKlrus6z/MwDG0YMueMFea4wRCEEVLKNrxt2/M813X9qowxpJBVXXAp5VsF7L3HeZqmrtj43PcNRvjXjVkpJdEjngoMAD+OI4aQ7KwrNgvjwdiSX2sNTMu5NzZXqUyx1mLOP7HtHvgP0FANuqxhapYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/fa8cf8a2f5e0504005c8df8b8036978d/15813/19-08-19.webp 190w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/1cdb2/19-08-19.webp 380w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/9046c/19-08-19.webp 760w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/c89f9/19-08-19.webp 1140w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/af3f0/19-08-19.webp 1280w\"\n              sizes=\"(max-width: 760px) 100vw, 760px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/fa8cf8a2f5e0504005c8df8b8036978d/a2d4f/19-08-19.png 190w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/3f520/19-08-19.png 380w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/3c051/19-08-19.png 760w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/b5cea/19-08-19.png 1140w,\n/static/fa8cf8a2f5e0504005c8df8b8036978d/21b4d/19-08-19.png 1280w\"\n            sizes=\"(max-width: 760px) 100vw, 760px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/fa8cf8a2f5e0504005c8df8b8036978d/3c051/19-08-19.png\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p> 구글링을 통해 발견한 <a href=\"https://enchoyism.github.io/2018/02/02/nodejs-mysql-connection-lost/\">enchoyi 님의 포스팅</a>을 통해 interactive<em>timeout, wati</em>timeout에 적혀있는 시간이 '활동하지 않는 커넥션을 끊을때까지 서버가 대기하는 시간'이라는 것을 알게 되었습니다.</p>\n<p> 제 mysql의 경우에는 28800초로 8시간동안 활동을 하지 않으면 서버가 커넥션을 끊어버린다는 것을 확인할 수 있습니다. 제가 작업 중인 웹 사이트는 현재 저 혼자만 접속하기 때문에 이는 하루만 지나도 서버의 연결이 끊어진다는 것을 의미하며, 결국 이 때문에 에러가 발생했다는 것을 알 수 있었습니다. </p>\n<p> 그렇다면 이를 해결하기 위해 DB서버 연결이 끊긴 것을 자동으로 확인하고 다시 연결 시키려면 어떻게 해야할까요?</p>\n<h3 id=\"error-해결-코드\" style=\"position:relative;\"><a href=\"#error-%ED%95%B4%EA%B2%B0-%EC%BD%94%EB%93%9C\" aria-label=\"error 해결 코드 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Error 해결 코드</h3>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> mysql <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'mysql'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> db <span class=\"token operator\">=</span> mysql<span class=\"token punctuation\">.</span><span class=\"token function\">createConnection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  host<span class=\"token operator\">:</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">,</span>\n  user<span class=\"token operator\">:</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">,</span>\n  password<span class=\"token operator\">:</span><span class=\"token string\">'---'</span><span class=\"token punctuation\">,</span>\n  database<span class=\"token operator\">:</span><span class=\"token string\">'---'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">handleDisconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  db<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>            \n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>                            \n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error when connecting to db:'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span>handleDisconnect<span class=\"token punctuation\">,</span> <span class=\"token number\">2000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n    <span class=\"token punctuation\">}</span>                                   \n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                                 \n                                         \n  db<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'db error'</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>code <span class=\"token operator\">===</span> <span class=\"token string\">'PROTOCOL_CONNECTION_LOST'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n      <span class=\"token keyword\">return</span> <span class=\"token function\">handleDisconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>                      \n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>                                    \n      <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span>                              \n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">handleDisconnect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><a href=\"https://stackoverflow.com/questions/20210522/nodejs-mysql-error-connection-lost-the-server-closed-the-connection\">stackoverflow에서 발견한 해결방법</a>을 바탕으로 위와 같은 소스코드를 작성하였습니다. mysql모듈을 로드하고 createConnection메소드를 이용해서 연결한 DB서버의 정보를 입력하는 것 까지는 기존과 동일합니다. 주의해서 볼 내용은 아래의 <code class=\"language-text\">handleDisconnection</code> 함수 파트입니다.</p>\n<p> 먼저 <code class=\"language-text\">db.connect</code>를 통해 db서버에 연결을 시도합니다. 그리고 <code class=\"language-text\">db.on</code>을 이용해서 DB서버와의 연결이 끊어졌는지 확인하고 연결이 끊어졌다면 <code class=\"language-text\">return handleDisconnect()</code> 코드를 통해 <code class=\"language-text\">handleDisconnect</code> 함수를 호출하여 다시 연결을 시도합니다. </p>","tableOfContents":"<ul>\n<li><a href=\"/Web/19-08-19-Connection%20lost-%20The%20server%20closed%20the%20connection%20%EC%97%90%EB%9F%AC%20%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0/#error%EC%9D%98-%EC%9B%90%EC%9D%B8\">Error의 원인</a></li>\n<li><a href=\"/Web/19-08-19-Connection%20lost-%20The%20server%20closed%20the%20connection%20%EC%97%90%EB%9F%AC%20%ED%95%B4%EA%B2%B0%ED%95%98%EA%B8%B0/#error-%ED%95%B4%EA%B2%B0-%EC%BD%94%EB%93%9C\">Error 해결 코드</a></li>\n</ul>","frontmatter":{"path":"/backend/19-08-19/","title":"Connection lost: The server closed the connection 에러 해결하기","category":"BackEnd","date":"2019-08-19"}}},"pageContext":{}},"staticQueryHashes":["2390655019","256249292","63159454"]}