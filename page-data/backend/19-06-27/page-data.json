{"componentChunkName":"component---src-templates-post-js","path":"/backend/19-06-27/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>이 글은 ‘오픈튜토리얼스-생활코딩’의 Egoing님의 <a href=\"https://opentutorials.org/course/3370/21378\">강의</a>를 정리했음을 먼저 밝힙니다.</p>\n</blockquote>\n<p> Express에서 중요한 기능 두 가지를 꼽으라고 하면 하나는 Route이고 하나는 미들웨어 입니다. 다른 사람이 만든 부품을 내 웹 페이지 구현을 위해 사용하는 방법 중 하나가 미들웨어입니다. <a href=\"https://expressjs.com/ko/resources/middleware.html\">Express홈페이지</a>에 들어가면 다양한 미들웨어들을 확인 할 수 있습니다. <a href=\"https://ko.wikipedia.org/wiki/%EB%AF%B8%EB%93%A4%EC%9B%A8%EC%96%B4\">위키피디아</a>에서 말하는 미들웨어의 정의는 다음과 같습니다. </p>\n<blockquote>\n<p>미들웨어는 양 쪽을 연결하여 데이터를 주고 받을 수 있도록 중간에서 매개 역할을 하는 소프트웨어, 네트워크를 통해서 연결된 여러 개의 컴퓨터에 있는 많은 프로세스들에게 어떤 서비스를 사용할 수 있도록 연결해 주는 소프트웨어를 말한다. 3계층 클라이언트/서버 구조에서 미들웨어가 존재한다. 웹 브라우저에서 데이터베이스로부터 데이터를 저장하거나 읽어올 수 있게 중간에 미들웨어가 존재하게 된다.</p>\n</blockquote>\n<h3>미들웨어의 형태</h3>\n<p> Express홈페이지에 들어가서 미들웨어의 기본적인 형태들에 대해서 살펴보도록 하겠습니다. 우리가 자주 사용하게 될 '애플리케이션 레벨 미들웨어'에 대해서 형태를 살펴보면 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Time:'</span><span class=\"token punctuation\">,</span> Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 콜백 함수에 첫 번째 인자로는 requset(요청), 두 번째 인자로는 response(응답), 세 번째 인자로는 next라는 다음 미들웨어를 실행시킬 지에 대한 정보가 들어갑니다. 이 코드의 경우에는 특정 경로에 대한 언급이 없으므로 어느 요청에 대해서나 실행됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/user/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Request Type:'</span><span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">.</span>method<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 특정 경로에 대한 요청만 실행하고 싶다면, 콜백 함수 앞에 path를 적어주도록 합니다. 위의 코드에서는 /user/:id 경로에 대한 요청만이 함수를 실행합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/user/:id'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'USER'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 위의 코드는 /user/:id 경로에 대한 GET요청을 실행합니다. 특정 경로가 아닌 모든 경로에서 요청을 실행하고 싶으면 경로에 '<strong>*</strong>'을 입력하면 됩니다! 이외에도 더 다양하고 자세한 설명은 <a href=\"https://expressjs.com/ko/guide/using-middleware.html#middleware.application\">Express공식 홈페이지</a>에서 한글로 확인 가능합니다.</p>\n<h3>미들웨어의 사용 1</h3>\n<p>Express내 미들웨어 중 <strong>body-parser</strong>를 사용해서 '게시글(파일) 작성' 코드를 수정해보도록 하겠습니다.</p>\n<p>먼저 body-parser 미들웨어를 npm을 이용해서 설치 해 주어야 합니다. <code class=\"language-text\">npm install body-parser --save</code> 를 터미널에서 실행합니다. 그리고 <code class=\"language-text\">var bodyParser = require(&#39;body-parser&#39;);</code> 를 코드의 적당한 자리에 선언해서 모듈을 로드 해 줍니다. 또한, 사용자가 요청을 할 때 form형태의 데이터로 요청을 했을 때 사용하는 <code class=\"language-text\">app.use(bodyParser.urlencoded({ extended: false }));</code> 를 코드의 적당한 자리에 선언해 줍니다. 아래에 예시를 참고하시면 됩니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> sanitizeHtml <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sanitize-html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> template <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./lib/template.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> extended<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 위의 코드에서 <code class=\"language-text\">app.use(bodyParser.urlencoded({ extended: false }))</code>를 집중해서 봐야 합니다. main.js가 실행될 때 마다 즉, 사용자가 어떤 요청을 할 때마다 body-parser 모듈에 의해서 미들웨어가 실행됩니다. 이로 인해 사용자가 전송한 post데이터가 내부적으로 분석이 되어 리퀘스트의 body속성을 만들고 여기에 정보를 추가 해 줍니다. (리퀘스트 이름이 request라고 한다면 'request.body'으로 사용 가능)</p>\n<p> 결국 우리가 가지고 있는 main.js 소스코드에서 /creat_process와 /update_process파트에서 사용되는 post정보들에 대해서, 미들웨어를 사용하면 body에 대한 코드를 더 간결하게 작성할 수 있게 됩니다. </p>\n<h3>미들웨어의 사용 2</h3>\n<p> 이번에는 <strong>compression</strong>이라는 미들웨어를 사용하면서 미들웨어에 대한 감각을 키워보도록 합시다. 이는 웹 서버가 웹 브라우저에게 응답할 때 데이터를 압축하도록 도와주는 미들웨어 입니다. 웹 사이트 내에서 너무 용량이 큰 정보가 계속 오고가면 돈도 많이 들고 시간도 많이 걸리게 되는데 compression이 이런 문제를 해결하도록 도와줍니다.</p>\n<p> 먼저 compression 미들웨어를 npm을 이용해서 설치 해 주어야 합니다. <code class=\"language-text\">npm install compression --save</code> 를 터미널에서 실행합니다. 그리고 <code class=\"language-text\">var compression = require(&#39;compression&#39;);</code> 를 코드의 적당한 자리에 선언해서 모듈을 로드해 줍니다. 마지막으로 <code class=\"language-text\">app.use(compression());</code> 를 코드의 적당한 자리에 선언해 줍니다. 아래에 예시를 참고하시면 됩니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> path <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'path'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> qs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> sanitizeHtml <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sanitize-html'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">var</span> compression <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'compression'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> template <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./lib/template.js'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n \napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> extended<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token function\">compression</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> <code class=\"language-text\">app.use()</code>를 통해서 <code class=\"language-text\">compression()</code>이라는 함수을 호출하면 미들웨어가 실행이 됩니다. <code class=\"language-text\">app.use()</code>에 compression 이나 body-parser같은 미들웨어를 장착하면 사용자가 요청을 보낼 때 마다 이런 미들웨어가 실행되어 코드에 적용한 대로 실행되게 됩니다.</p>\n<h3>정적인 파일 서비스하기</h3>\n<p>더 다양한 미들웨어에 대해서 알아보도록 하겠습니다.</p>\n<p>이미지파일이나 자바스크립트, css파일을 웹 브라우저로 다운로드시켜주는 경우에 이런 것들을 정적인 파일이라고 합니다. 이런 정적인 파일들을 우리 웹 사이트에서 어떻게 express버전으로 사용할 수 있는지 알아보도록 하겠습니다. </p>\n<p> 이를 위해서는 우리가 정적인 파일을 서비스하는 것을 허용하고, 셋팅해야 하는데 이 또한 Express 홈 페이지에 설명이 잘 되어 있습니다. static이라고 하는 express가 기본적으로 내장하고 있는 미들웨어를 사용하면 되는데 일단은 아래와 같은 코드를 적어 보도록 하겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>express<span class=\"token punctuation\">.</span><span class=\"token function\">static</span><span class=\"token punctuation\">(</span><span class=\"token string\">'public'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 아래와 같이 main.js 파일이 있는 폴더에 public폴더, 그리고 public폴더 내 images폴더, 그리고 그 안에 이미지 파일을 넣어주도록 하겠습니다. hello.jpg라는 이미지 파일을 넣었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 594px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f66afd47c404b864f1c0db15c1855b0e/5fd3e/19-06-26-4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.210526315789476%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAmklEQVQY05XQQQ7CIBAFUM5S0AJtQayFSltFGl10ZaIb73+QL3WhS8PiZZJZ/D8ZwhiDMQZa7+C9h1IaRVFg3VOaj0jZoG0tpjEgxiusPUJKharSicpGrJ0wDBHhcsOy3PF4vjDPSyrx6PsznDtlISUXaGoDa9bgESHEFDSg6xyEqMB5HkIpRbkV2NcuXXVILf0XY5vPL3/zvzeFl5n2iyf91AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f66afd47c404b864f1c0db15c1855b0e/15813/19-06-26-4.webp 190w,\n/static/f66afd47c404b864f1c0db15c1855b0e/1cdb2/19-06-26-4.webp 380w,\n/static/f66afd47c404b864f1c0db15c1855b0e/bc223/19-06-26-4.webp 594w\"\n              sizes=\"(max-width: 594px) 100vw, 594px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f66afd47c404b864f1c0db15c1855b0e/a2d4f/19-06-26-4.png 190w,\n/static/f66afd47c404b864f1c0db15c1855b0e/3f520/19-06-26-4.png 380w,\n/static/f66afd47c404b864f1c0db15c1855b0e/5fd3e/19-06-26-4.png 594w\"\n            sizes=\"(max-width: 594px) 100vw, 594px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f66afd47c404b864f1c0db15c1855b0e/5fd3e/19-06-26-4.png\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p><code class=\"language-text\">app.use(express.static(&#39;public&#39;));</code> 코드는, public폴더에 있는 정적인 파일을 서비스하겠다는 의미이기 때문에 main.js 소스코드 내에서 public폴더 내 정적 파일들을 자유롭게 사용할 수 있게 됩니다. 아래는 간단한 예시 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token keyword\">var</span> title <span class=\"token operator\">=</span> <span class=\"token string\">'Welcome'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> description <span class=\"token operator\">=</span> <span class=\"token string\">'Hello, Node.js'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> list <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">,</span> list<span class=\"token punctuation\">,</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">\n    &lt;h2></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>title<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/h2></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>description<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\n    &lt;img src=\"/images/hello.jpg\" style=\"width:300px; display:block; margin-top:10px;\">\n    </span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;a href=\"/create\">create&lt;/a></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n  response<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 위의 코드에 의해서 우리의 웹 페이지에는 hello.jpg 파일이 업로드 됩니다.</p>\n<h3>에러 처리</h3>\n<p> Express 홈 페이지를 보니, 우리가 요청에 대한 정보를 찾지 못했을 때 출력하는 Not found: 404에 대한 내용이 잘 설명되어 있습니다. 코드를 아래에 적어보도록 하겠습니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">404</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Sorry cant find that!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 이 또한 미들웨어인데 이 경우에는 기존의 미들웨어들 과는 달리 <strong>소스코드의 마지막</strong>에 선언해야 합니다. 미들웨어는 순차적으로 실행이 되기 때문에 일단은 먼저 앞에 있는 미들웨어들을 전부 훑은 후에 아무런 적합한 미들웨어를 실행시키지 못했을 때 404에 대한 미들웨어를 실행시켜 주어야 하기 때문입니다. </p>\n<p> 그렇다면 요청에 대한 적합한 미들웨어를 실행시키지 못한 것이 아니라, 코드 중간중간에 에러 정보가 발생하면 어떻게 처리해야 할까요? </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/page/:pageId'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n  <span class=\"token keyword\">var</span> filteredId <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>pageId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>base<span class=\"token punctuation\">;</span>\n  fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">data/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>filteredId<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf8'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> description</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token function\">next</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> title <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>params<span class=\"token punctuation\">.</span>pageId<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> sanitizedTitle <span class=\"token operator\">=</span> <span class=\"token function\">sanitizeHtml</span><span class=\"token punctuation\">(</span>title<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> sanitizedDescription <span class=\"token operator\">=</span> <span class=\"token function\">sanitizeHtml</span><span class=\"token punctuation\">(</span>description<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n        allowedTags<span class=\"token operator\">:</span><span class=\"token punctuation\">[</span><span class=\"token string\">'h1'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> list <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token function\">list</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>list<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">var</span> html <span class=\"token operator\">=</span> template<span class=\"token punctuation\">.</span><span class=\"token constant\">HTML</span><span class=\"token punctuation\">(</span>sanitizedTitle<span class=\"token punctuation\">,</span> list<span class=\"token punctuation\">,</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">&lt;h2></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sanitizedTitle<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&lt;/h2></span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sanitizedDescription<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> &lt;a href=\"/create\">create&lt;/a>\n          &lt;a href=\"/update/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sanitizedTitle<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\">update&lt;/a>\n          &lt;form action=\"/delete_process\" method=\"post\">\n            &lt;input type=\"hidden\" name=\"id\" value=\"</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>sanitizedTitle<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\">\n            &lt;input type=\"submit\" value=\"delete\">\n          &lt;/form></span><span class=\"token template-punctuation string\">`</span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      response<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> req<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> next</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">.</span>stack<span class=\"token punctuation\">)</span>\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Something broke!'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p> 첫 번째 소스코드에서 if문과 else문을 나눠져 있는 것에 주목해 봅시다. if문은 에러가 발생했을 때 실행하는 코드이고 else문은 에러가 발생하지 않았을 때 실행하는 코드인 것을 알 수 있습니다. 에러가 발생한 if문에서는 next라는 함수안에 err를 건네주는데, express 내부적으로 다음 미들웨어를 실행 시킬 때 에러가 없으면 <code class=\"language-text\">next()</code>를 사용하고, 에러가 있으면 <code class=\"language-text\">next(err)</code>를 사용한다고 약속되어 있습니다.  </p>\n<p> 그리고 <code class=\"language-text\">next(err)</code>가 실행된 경우에는 두 번째 소스코드가 실행되어 에러를 처리할 수 있게 됩니다. 여기서 주의할 점은 두번째 소스코드의 내용은 <strong>404에러 처리 미들웨어 코드보다 뒤</strong>에 선언되어야 한다는 점입니다. </p>","frontmatter":{"path":"/backend/19-06-27/","title":"Express 미들웨어","category":"BackEnd","date":"2019-06-27"}}},"pageContext":{}},"staticQueryHashes":["2390655019","256249292","63159454"]}