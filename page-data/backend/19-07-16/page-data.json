{"componentChunkName":"component---src-templates-post-js","path":"/backend/19-07-16/","result":{"data":{"markdownRemark":{"html":"<blockquote>\n<p>이 글은 ‘오픈튜토리얼스-생활코딩’의 Egoing님의 <a href=\"https://opentutorials.org/course/2136/11959\">강의</a>를 정리했음을 먼저 밝힙니다. </p>\n</blockquote>\n<p> 사용자가 업로드한 파일을 우리 서버컴퓨터의 원하는 디렉토리에 저장하는 기술을 express가 기본적으로 제공하고 있지는 않기 때문에, <strong>multer</strong>라는 모듈을 설치하여 이를 처리해야 합니다. <code class=\"language-text\">npm install --save multer</code> 명령어를 통해 우리 프로젝트에 multer모듈을 설치 해 줍시다. 그리고 노드파일 내 아래와 같이 소스코드를 추가하여 uploads라는 디렉토리에 사용자가 전달 한 파일이 저장되도록 설정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> multer <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'multer'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> upload <span class=\"token operator\">=</span> <span class=\"token function\">multer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>dest<span class=\"token operator\">:</span> <span class=\"token string\">'uploads/'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>업로드 form</h3>\n<p> pug파일의 형태로 업로드 폼을 만들어 보겠습니다. (저는 upload.pug라는 이름으로 생성하였습니다.)아래와 같이 코드를 작성해 주시면 됩니다. 여기서 method는 당연히 <strong>post방식</strong>으로 해야하며, <code class=\"language-text\">enctype=&#39;multipart/form-data&#39;</code>를 꼭 적어넣어 주셔야 합니다. 그래야만 사용자가 전송한 파일 데이터를 서버로 전송 할 수 있습니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">doctype html\nhtml\n    head\n        meta(charset='utf-8')\n    body\n        form(action='upload' method='post' enctype='multipart/form-data')\n            input(type='file' name='userfile')\n            input(type='submit')</code></pre></div>\n<h3>multer</h3>\n<ul>\n<li><a href=\"https://github.com/expressjs/multer/blob/master/doc/README-ko.md\">multer 깃헙 홈페이지</a>에 사용법이 자세히 설명되어있으니 참고하시길 바랍니다.</li>\n</ul>\n<p> 우리가 위의 업로드 폼에서 upload라는 path에 post방식으로 파일을 보냈으니, upload라는 path에 post방식으로 들어온 이 정보를 라우터를 사용해서 받은 뒤, multer모듈을 사용해서 uploads라는 디렉토리로 보내주어야 합니다. 그럴 때에는 노드파일에 아래와 같이 소스코드를 작성 해 주면 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">app<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/upload'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\tres<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'upload'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/upload'</span><span class=\"token punctuation\">,</span> upload<span class=\"token punctuation\">.</span><span class=\"token function\">single</span><span class=\"token punctuation\">(</span><span class=\"token string\">'userfile'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\tres<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Uploaded'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>app.post 함수의 실행 순서를 정리 해 보겠습니다.</p>\n<ol>\n<li>첫 번째로 라우터가 <strong>/upload로 들어온 post정보</strong>를 받습니다. </li>\n<li>두 번째로 <strong>multer미들웨어가 userfile이라는 name으로 들어온 파일정보를 upload디렉토리로 전송</strong>합니다. </li>\n<li>세 번째로는 <code class=\"language-text\">function(){res.send(&#39;Uploaded&#39;)}</code> <strong>콜백함수가 실행</strong>됩니다. </li>\n</ol>\n<p> 부가적으로, multer미들웨어를 사용하면 request객체에 사용자가 우리에게 전송한 파일에 대한 정보가 <strong>req.file</strong>의 형태로 담깁니다. req.file 객체 내에는 <strong>fieldname, originalname, filename, path, size</strong> 등의 정보가 담기기 때문에 이를 다양한 방법으로 활용 할 수 있습니다.</p>\n<h3>multer의 활용</h3>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 760px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8085d496d4c39e4a20b965b1cd14e4b/21b4d/19-07-16-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.10526315789473%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKklEQVQoz41Ri27DIBDr/3/k2uZFSgjk0YwESDwfVTtNq7Sd5BDrwPjM6TgOSC3LgrQnPGvfd2jdwTmXuex77n2u7+okn870qBqFGwWGccL5UuDjfIV1A/mIdd0QYkJK+/8ETe/QUkwOjdOMsqpxKcp8iXUjPAW3EBFT+uH2HbKgpsOCItN9oaP5JVarFu1NQ7UaTXvDum1/O5SsDAUVD5veoreOERiOr8n73BNRiaPrTM7VsB9C+OX2NbL/9Flomjwd+uzSDnfYcaGriMDsQtyxCULKWBnBAw++Ma48cnZIJ/IwAk0XluLiVrj0dNdll8Kl5/hYknX+H0ZiwDzfvwXrukZRlnyMChWzVC2zIxrm2CiFsqxwvRbsVYxGcZIJMUZszFTgvc+r1BeY+2ljTk1YVwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/f8085d496d4c39e4a20b965b1cd14e4b/15813/19-07-16-1.webp 190w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/1cdb2/19-07-16-1.webp 380w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/9046c/19-07-16-1.webp 760w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/c89f9/19-07-16-1.webp 1140w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/af3f0/19-07-16-1.webp 1280w\"\n              sizes=\"(max-width: 760px) 100vw, 760px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/f8085d496d4c39e4a20b965b1cd14e4b/a2d4f/19-07-16-1.png 190w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/3f520/19-07-16-1.png 380w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/3c051/19-07-16-1.png 760w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/b5cea/19-07-16-1.png 1140w,\n/static/f8085d496d4c39e4a20b965b1cd14e4b/21b4d/19-07-16-1.png 1280w\"\n            sizes=\"(max-width: 760px) 100vw, 760px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/f8085d496d4c39e4a20b965b1cd14e4b/3c051/19-07-16-1.png\"\n            alt=\"img\"\n            title=\"img\"\n            loading=\"lazy\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p> multer 모듈의 깃헙 홈페이지에 나와있는 설명입니다. 저는 dest가 아닌 storage 옵션을 사용해보도록 하겠습니다. 그러기 위해서는 아래와 같이 모듈을 로드해야합니다. destination은 사용자가 전송한 파일을 어느 디렉토리에 저장하는지를 나타내고, filename은 그 디렉토리에 저장한 파일의 이름을 어떻게 할 것인가를 나타냅니다. 그래서 아래와 같이 모듈을 로드 한 뒤에 upload라는 변수를 사용하게되면, storage 변수가 가리키는 <strong>destination에 filename의 이름으로 파일이 저장</strong>됩니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">var</span> storage <span class=\"token operator\">=</span> multer<span class=\"token punctuation\">.</span><span class=\"token function\">diskStorage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">destination</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'uploads/'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">filename</span><span class=\"token operator\">:</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> file<span class=\"token punctuation\">.</span>originalname<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> upload <span class=\"token operator\">=</span> <span class=\"token function\">multer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>storage<span class=\"token operator\">:</span> _storage<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p> 이 외 에도, 조건문이 포함 된 코드를 사용하면 이미지와 텍스트 파일을 서로 다른 디렉토리에 저장이 가능하며, 동일 이름의 파일이 존재 할 때에도 조건문을 통해 다르게 처리가 가능합니다. 그리고 이 내용과 같이 '정적파일'을 서비스 하는 방법도 공부하면 좋을 것 같습니다.</p>\n<h3>다중 업로드</h3>\n<p> 여러 개의 파일을 한 번에 올리고 싶다면 아래의 두 가지를 기억하시면 됩니다.</p>\n<ol>\n<li>upload.single 이 아닌 <strong>upload.array</strong>를 사용한다!</li>\n<li>HTML form에서 파일 업로드 부분에 <strong>mutiple/ 속성</strong>을 추가 해 준다!</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\">form(action=\"/create\" method=\"post\" enctype='multipart/form-data')\n    input(type='file' name='userfile' multiple/)\n    input(type=\"submit\")</code></pre></div>","frontmatter":{"path":"/backend/19-07-16/","title":"Express 파일 업로드를 위한 multer 모듈의 사용","category":"BackEnd","date":"2019-07-16"}}},"pageContext":{}},"staticQueryHashes":["2390655019","256249292","63159454"]}